# æŒ‰é”®å¤„ç†æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ¯ **é—®é¢˜èƒŒæ™¯**

åŸå§‹è®¾è®¡ä¸­ï¼Œ`page_manager_lvgl.c` åªå¤„ç† `LV_KEY_RIGHT` è¿›è¡Œé¡µé¢å¯¼èˆªï¼Œå…¶ä»–æŒ‰é”®æ²¡æœ‰å¾—åˆ°é€‚å½“å¤„ç†ã€‚å„ä¸ªé¡µé¢æ— æ³•å“åº”é¡µé¢ç‰¹å®šçš„æŒ‰é”®æ“ä½œã€‚

## ğŸ—ï¸ **æ–°æ¶æ„è®¾è®¡**

### **åˆ†å±‚æŒ‰é”®å¤„ç†æœºåˆ¶**

```
æŒ‰é”®äº‹ä»¶æµå‘ï¼š
Hardware Button â†’ LVGL Input Device â†’ Screen Level Handler â†’ Page-specific Handler â†’ Global Handler
```

### **å¤„ç†ä¼˜å…ˆçº§**

1. **é¡µé¢çº§å¤„ç†å™¨** - æœ€é«˜ä¼˜å…ˆçº§ï¼Œé¡µé¢å¯ä»¥"æ‹¦æˆª"ç‰¹å®šæŒ‰é”®
2. **å…¨å±€å¯¼èˆªå¤„ç†å™¨** - å¤„ç†é€šç”¨å¯¼èˆªæŒ‰é”®ï¼ˆå¦‚`LV_KEY_RIGHT`ï¼‰
3. **æœªå¤„ç†æŒ‰é”®** - è®°å½•æ—¥å¿—ä½†ä¸å½±å“ç³»ç»Ÿè¿è¡Œ

## ğŸ“‹ **å®ç°ç»†èŠ‚**

### **1. é¡µé¢æ§åˆ¶å™¨æ¥å£æ‰©å±•**

åœ¨ `page_manager.h` ä¸­ä¸ºé¡µé¢æ§åˆ¶å™¨æ·»åŠ æŒ‰é”®å¤„ç†é’©å­ï¼š

```c
typedef struct {
    // ç”Ÿå‘½å‘¨æœŸå‡½æ•°
    esp_err_t (*init)(void);
    esp_err_t (*create)(void);
    esp_err_t (*update)(void);
    esp_err_t (*destroy)(void);
    
    // æ•°æ®çŠ¶æ€ç®¡ç†
    bool (*is_data_updated)(void);
    
    // ğŸ†• è¾“å…¥äº‹ä»¶å¤„ç†ï¼ˆå¯é€‰ï¼‰
    bool (*handle_key_event)(uint32_t key);  // è¿”å›trueè¡¨ç¤ºå·²å¤„ç†
    
    // é¡µé¢ä¿¡æ¯
    const char *name;
    page_id_t page_id;
} page_controller_t;
```

### **2. é¡µé¢ç®¡ç†å™¨æŒ‰é”®åˆ†å‘**

åœ¨ `page_manager.c` ä¸­æ·»åŠ æŒ‰é”®äº‹ä»¶åˆ†å‘å‡½æ•°ï¼š

```c
bool page_manager_handle_key_event(uint32_t key)
{
    // è·å–å½“å‰é¡µé¢æ§åˆ¶å™¨
    const page_controller_t *controller = g_page_controllers[g_current_page];
    
    // é¦–å…ˆè®©å½“å‰é¡µé¢å¤„ç†æŒ‰é”®äº‹ä»¶
    if (controller->handle_key_event) {
        bool handled = controller->handle_key_event(key);
        if (handled) {
            return true;  // é¡µé¢å·²å¤„ç†ï¼Œæ— éœ€å…¨å±€å¤„ç†
        }
    }
    
    return false;  // é¡µé¢æœªå¤„ç†ï¼Œäº¤ç»™å…¨å±€å¤„ç†å™¨
}
```

### **3. LVGL å±å¹•çº§æŒ‰é”®å¤„ç†å™¨**

åœ¨ `page_manager_lvgl.c` ä¸­ä¿®æ”¹å±å¹•çº§æŒ‰é”®å¤„ç†ï¼š

```c
static void screen_key_event_cb(lv_event_t *e)
{
    uint32_t key = lv_event_get_key(e);
    
    // ğŸ†• é¦–å…ˆè¯¢é—®å½“å‰é¡µé¢æ˜¯å¦è¦å¤„ç†æ­¤æŒ‰é”®
    bool page_handled = page_manager_handle_key_event(key);
    if (page_handled) {
        return;  // é¡µé¢å·²å¤„ç†ï¼Œå®Œæˆ
    }
    
    // é¡µé¢æœªå¤„ç†ï¼Œæ‰§è¡Œå…¨å±€å¯¼èˆªé€»è¾‘
    if (key == LV_KEY_RIGHT) {
        page_manager_lvgl_next();  // å¯¼èˆªåˆ°ä¸‹ä¸€é¡µ
    } else if (key == LV_KEY_ENTER) {
        // å…¨å±€ENTERæŒ‰é”®å¤„ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
    }
    // å…¶ä»–æŒ‰é”®è®°å½•ä½†ä¸å¤„ç†
}
```

## ğŸ”§ **å„é¡µé¢æŒ‰é”®å¤„ç†ç¤ºä¾‹**

### **Monitor é¡µé¢**

```c
static bool monitor_page_handle_key_event(uint32_t key)
{
    switch (key) {
        case LV_KEY_ENTER:
            // åˆ‡æ¢ç”µæºä¿¡æ¯æ˜¾ç¤ºæ¨¡å¼
            ESP_LOGI(TAG, "Toggle power info display");
            return true;
            
        case LV_KEY_UP:
            // å¢åŠ æ˜¾ç¤ºäº®åº¦
            ESP_LOGI(TAG, "Increase brightness");
            return true;
            
        case LV_KEY_DOWN:
            // é™ä½æ˜¾ç¤ºäº®åº¦
            ESP_LOGI(TAG, "Decrease brightness");
            return true;
            
        default:
            return false;  // è®©å…¨å±€å¤„ç†å™¨å¤„ç†
    }
}
```

### **ESP-NOW é¡µé¢**

```c
static bool espnow_page_handle_key_event(uint32_t key)
{
    switch (key) {
        case LV_KEY_ENTER:
            // å‘é€æµ‹è¯•æ•°æ®åŒ…
            ESP_LOGI(TAG, "Send test packet");
            g_packets_sent++;
            return true;
            
        case LV_KEY_UP:
            // å¢åŠ å‘å°„åŠŸç‡
            ESP_LOGI(TAG, "Increase transmission power");
            return true;
            
        case LV_KEY_DOWN:
            // é™ä½å‘å°„åŠŸç‡
            ESP_LOGI(TAG, "Decrease transmission power");
            return true;
            
        default:
            return false;  // è®©å…¨å±€å¤„ç†å™¨å¤„ç†
    }
}
```

## ğŸ® **æŒ‰é”®åŠŸèƒ½æ˜ å°„**

| æŒ‰é”® | å…¨å±€åŠŸèƒ½ | Monitoré¡µé¢ | ESP-NOWé¡µé¢ |
|------|----------|-------------|-------------|
| **RIGHT** | ä¸‹ä¸€é¡µå¯¼èˆª | - | - |
| **ENTER** | - | åˆ‡æ¢ç”µæºæ˜¾ç¤º | å‘é€æµ‹è¯•åŒ… |
| **UP** | - | å¢åŠ äº®åº¦ | å¢åŠ å‘å°„åŠŸç‡ |
| **DOWN** | - | é™ä½äº®åº¦ | é™ä½å‘å°„åŠŸç‡ |

## âœ… **æ¶æ„ä¼˜åŠ¿**

### **1. æ¸…æ™°çš„èŒè´£åˆ†ç¦»**
- **å…¨å±€å¯¼èˆª**: é¡µé¢åˆ‡æ¢ç”±é¡µé¢ç®¡ç†å™¨ç»Ÿä¸€å¤„ç†
- **é¡µé¢åŠŸèƒ½**: é¡µé¢ç‰¹å®šæ“ä½œç”±å„é¡µé¢è‡ªå·±å¤„ç†
- **æ‰©å±•æ€§å¼º**: æ–°é¡µé¢å¯ä»¥è½»æ¾æ·»åŠ è‡ªå®šä¹‰æŒ‰é”®è¡Œä¸º

### **2. ç¬¦åˆLVGLæœ€ä½³å®è·µ**
- ä½¿ç”¨æ ‡å‡†çš„LVGLäº‹ä»¶å¤„ç†æœºåˆ¶
- å±å¹•çº§äº‹ä»¶å¤„ç†å™¨ä½œä¸ºäº‹ä»¶åˆ†å‘ä¸­å¿ƒ
- é¡µé¢æ§åˆ¶å™¨æ¨¡å¼ä¾¿äºç®¡ç†å¤æ‚äº¤äº’

### **3. çµæ´»çš„æŒ‰é”®å“åº”**
- é¡µé¢å¯ä»¥"æ‹¦æˆª"ä»»ä½•æŒ‰é”®è¿›è¡Œç‰¹æ®Šå¤„ç†
- æœªå¤„ç†çš„æŒ‰é”®è‡ªåŠ¨å›é€€åˆ°å…¨å±€å¤„ç†
- æ”¯æŒé¡µé¢é—´æŒ‰é”®è¡Œä¸ºçš„å·®å¼‚åŒ–

### **4. æ˜“äºè°ƒè¯•å’Œç»´æŠ¤**
- è¯¦ç»†çš„æ—¥å¿—è®°å½•æ˜¾ç¤ºæŒ‰é”®å¤„ç†è·¯å¾„
- æ˜ç¡®çš„è¿”å›å€¼æŒ‡ç¤ºå¤„ç†çŠ¶æ€
- æ¨¡å—åŒ–è®¾è®¡ä¾¿äºå•ç‹¬æµ‹è¯•

## ğŸš€ **ä½¿ç”¨æ–¹æ³•**

### **ä¸ºæ–°é¡µé¢æ·»åŠ æŒ‰é”®å¤„ç†**

1. **åœ¨é¡µé¢å®ç°æ–‡ä»¶ä¸­æ·»åŠ æŒ‰é”®å¤„ç†å‡½æ•°**:
   ```c
   static bool my_page_handle_key_event(uint32_t key) {
       // å¤„ç†é¡µé¢ç‰¹å®šæŒ‰é”®
       return handled;
   }
   ```

2. **åœ¨é¡µé¢æ§åˆ¶å™¨ä¸­æ³¨å†Œå¤„ç†å‡½æ•°**:
   ```c
   static const page_controller_t my_controller = {
       // ... å…¶ä»–å‡½æ•°
       .handle_key_event = my_page_handle_key_event,
       // ... å…¶ä»–å±æ€§
   };
   ```

3. **æŒ‰é”®äº‹ä»¶å°†è‡ªåŠ¨è·¯ç”±åˆ°é¡µé¢å¤„ç†å™¨**

## ğŸ¯ **æœ€ä½³å®è·µå»ºè®®**

1. **ä¿æŒä¸€è‡´æ€§**: ç›¸åŒæŒ‰é”®åœ¨ä¸åŒé¡µé¢åº”æœ‰ç›¸ä¼¼çš„åŠŸèƒ½é€»è¾‘
2. **æä¾›åé¦ˆ**: æŒ‰é”®æ“ä½œåº”é€šè¿‡UIæˆ–æ—¥å¿—æä¾›æ˜ç¡®åé¦ˆ
3. **ä¼˜é›…é™çº§**: é¡µé¢åº”åªå¤„ç†çœŸæ­£éœ€è¦çš„æŒ‰é”®ï¼Œå…¶ä»–äº¤ç»™å…¨å±€
4. **æ–‡æ¡£åŒ–**: æ¯ä¸ªé¡µé¢çš„æŒ‰é”®åŠŸèƒ½åº”åœ¨æ³¨é‡Šä¸­æ˜ç¡®è¯´æ˜

è¿™ä¸ªæ¶æ„ä¸ºM5StickC Plus 1.1æä¾›äº†å¼ºå¤§ä¸”çµæ´»çš„æŒ‰é”®å¤„ç†èƒ½åŠ›ï¼Œæ—¢ä¿æŒäº†å…¨å±€å¯¼èˆªçš„ä¸€è‡´æ€§ï¼Œåˆå…è®¸å„é¡µé¢å®ç°ç‹¬ç‰¹çš„äº¤äº’åŠŸèƒ½ã€‚